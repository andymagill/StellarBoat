---
/**
 * Lead capture form component.
 *
 * A four-field lead generation form (name, email, company, phone) with:
 * - Required fields: name, email
 * - Optional fields: company, phone
 * - Same progressive enhancement as ContactForm
 * - Backend override support
 *
 * @example
 * ```astro
 * <!-- Uses global Web3Forms backend -->
 * <LeadCaptureForm />
 *
 * <!-- Override backend -->
 * <LeadCaptureForm backend="api" apiUrl="https://api.mysite.com/leads" />
 * ```
 */

import { forms } from '../../config/forms';
import FormField from './FormField.astro';
import Button from '../ui/Button.astro';
import type { FormsConfig } from '../../types/config';

export interface Props {
  backend?: FormsConfig['defaultBackend'];
  apiUrl?: string;
  web3formsKey?: string;
  formspreeEndpoint?: string;
  formsparProjectId?: string;
  class?: string;
}

const {
  backend = forms.defaultBackend,
  apiUrl = forms.apiUrl,
  web3formsKey = forms.web3formsKey,
  formspreeEndpoint = forms.formspreeEndpoint,
  formsparProjectId = forms.formsparProjectId,
  class: className = '',
} = Astro.props;

const getFormAction = (): string => {
  switch (backend) {
    case 'web3forms':
      return 'https://api.web3forms.com/submit';
    case 'netlify':
      return '/?no-cache=1';
    case 'api':
      return apiUrl || '#';
    case 'formspree':
      return formspreeEndpoint || '#';
    case 'formspark':
      return 'https://submit-form.com/formsparkapi';
    default:
      return '#';
  }
};
---

<form method="POST" action={getFormAction()} class={`space-y-6 ${className}`}>
  {
    backend === 'web3forms' && (
      <input type="hidden" name="access_key" value={web3formsKey} />
    )
  }
  {
    backend === 'netlify' && (
      <input type="hidden" name="form-name" value="lead-capture" />
    )
  }
  {
    backend === 'formspark' && (
      <input type="hidden" name="projectId" value={formsparProjectId} />
    )
  }

  <FormField
    id="name"
    label="Full Name"
    type="text"
    required
    placeholder="John Doe"
  />

  <FormField
    id="email"
    label="Email Address"
    type="email"
    required
    placeholder="you@company.com"
    autocomplete="email"
  />

  <FormField
    id="company"
    label="Company"
    type="text"
    placeholder="Your Company"
    autocomplete="organization"
  />

  <FormField
    id="phone"
    label="Phone"
    type="tel"
    placeholder="+1 (555) 000-0000"
    autocomplete="tel"
  />

  <div id="lead-capture-form-messages" class="hidden"></div>

  <Button type="submit" variant="primary" size="md">Get Started</Button>
</form>

<script
  define:vars={{
    backend,
    apiUrl,
    web3formsKey,
    formspreeEndpoint,
    formsparProjectId,
  }}
>
  const form = document.querySelector('form');
  const messagesContainer = document.getElementById(
    'lead-capture-form-messages'
  );
  const submitButton = form?.querySelector('button[type="submit"]');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => {
      if (
        !key.startsWith('_') &&
        key !== 'access_key' &&
        key !== 'form-name' &&
        key !== 'projectId'
      ) {
        data[key] = String(value);
      }
    });

    submitButton.disabled = true;
    submitButton.setAttribute('aria-busy', 'true');

    try {
      const { submitForm } = await import('../../utils/forms');

      const result = await submitForm(data, {
        defaultBackend: backend,
        apiUrl,
        web3formsKey,
        formspreeEndpoint,
        formsparProjectId,
      });

      messagesContainer.innerHTML = '';

      if (result.ok) {
        const successAlert = document.createElement('div');
        successAlert.className =
          'p-4 bg-success/10 border border-success text-success rounded-md';
        successAlert.setAttribute('role', 'status');
        successAlert.textContent = "Thank you! We'll be in touch shortly.";
        messagesContainer.appendChild(successAlert);
        messagesContainer.classList.remove('hidden');
        form.reset();
      } else {
        const errorAlert = document.createElement('div');
        errorAlert.className =
          'p-4 bg-error/10 border border-error text-error rounded-md';
        errorAlert.setAttribute('role', 'alert');
        errorAlert.textContent =
          result.error || 'Something went wrong. Please try again.';
        messagesContainer.appendChild(errorAlert);
        messagesContainer.classList.remove('hidden');
      }
    } catch (error) {
      messagesContainer.innerHTML = '';
      const errorAlert = document.createElement('div');
      errorAlert.className =
        'p-4 bg-error/10 border border-error text-error rounded-md';
      errorAlert.setAttribute('role', 'alert');
      errorAlert.textContent =
        error instanceof Error
          ? error.message
          : 'An unexpected error occurred.';
      messagesContainer.appendChild(errorAlert);
      messagesContainer.classList.remove('hidden');
    } finally {
      submitButton.disabled = false;
      submitButton.removeAttribute('aria-busy');
    }
  });
</script>
