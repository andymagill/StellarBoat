---
import { analytics } from '../../config/analytics';

const shouldRender = analytics.consentMode;
---

{
  shouldRender && (
    <div
      id="consent-banner"
      class="fixed bottom-0 left-0 right-0 z-50 bg-surface border-t border-border p-4 shadow-lg"
      role="region"
      aria-label="Consent banner"
      aria-live="polite"
    >
      <div class="mx-auto max-w-4xl">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <div class="flex-1">
            <p class="text-sm text-foreground-secondary">
              We use cookies and analytics to improve your experience. By
              accepting, you consent to our use of cookies.
            </p>
          </div>
          <div class="flex gap-3 flex-shrink-0">
            <button
              id="consent-decline"
              class="px-4 py-2 text-sm font-medium rounded border border-border bg-transparent text-foreground hover:bg-surface-secondary transition-colors"
              aria-label="Decline analytics cookies"
            >
              Decline
            </button>
            <button
              id="consent-accept"
              class="px-4 py-2 text-sm font-medium rounded bg-primary text-primary-foreground hover:bg-primary-600 transition-colors"
              aria-label="Accept analytics cookies"
            >
              Accept
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}

<script>
  function initConsentBanner() {
    var b = document.getElementById('consent-banner');
    var a = document.getElementById('consent-accept');
    var d = document.getElementById('consent-decline');
    if (!b || !a || !d) return;
    if (document.cookie.includes('consent=')) {
      b.style.display = 'none';
      return;
    }
    var hasDataLayer =
      typeof window !== 'undefined' && Array.isArray(window.dataLayer);
    a.addEventListener('click', function () {
      if (hasDataLayer && typeof gtag === 'function') {
        var cfg = {};
        cfg.analytics_storage = 'granted';
        cfg.ad_storage = 'granted';
        cfg.ad_user_data = 'granted';
        cfg.ad_personalization = 'granted';
        gtag('consent', 'update', cfg);
      }
      document.cookie =
        'consent=granted; max-age=31536000; path=/; SameSite=Lax';
      b.style.display = 'none';
    });
    d.addEventListener('click', function () {
      if (hasDataLayer && typeof gtag === 'function') {
        var cfg2 = {};
        cfg2.analytics_storage = 'denied';
        cfg2.ad_storage = 'denied';
        cfg2.ad_user_data = 'denied';
        cfg2.ad_personalization = 'denied';
        gtag('consent', 'update', cfg2);
      }
      document.cookie =
        'consent=declined; max-age=31536000; path=/; SameSite=Lax';
      b.style.display = 'none';
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initConsentBanner);
  } else {
    initConsentBanner();
  }
</script>
